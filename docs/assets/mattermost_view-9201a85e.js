import{d as x,u as A,r as v,a as j,b as p,o as D,c as O,w as n,g as w,e as P,f as o,m as C,h as f,i as T,j as N,k as z,n as V,_ as G,l as H,F as K}from"./index-df6f743d.js";import{i as h,_ as L,P as I,j as q,d as W,r as Y,k as Q,l as J,a as X}from"./tf_deployment_list.vue_vue_type_script_setup_true_lang-1803a4f6.js";import{_ as U}from"./select_gateway_node.vue_vue_type_script_setup_true_lang-ef88227d.js";import{c as Z,_ as $}from"./smtp_server.vue_vue_type_script_setup_true_lang-26828204.js";import"./list_table.vue_vue_type_script_setup_true_lang-046c7938.js";const ee=N("a",{target:"_blank",href:"https://manual.grid.tf/weblets/weblets_mattermost.html",class:"app-link"}," Quick start documentation ",-1),ae={name:"TfMattermost",components:{SmtpServer:$,SelectSolutionFlavor:h,SelectGatewayNode:U,SelectFarm:L}},te=x({...ae,setup(R){const t=A(),b=v(),_=j(),l=v("MM"+w(9)),a=v(),r=v(),s=v(),m=v(Z());async function B(){t.value.setStatus("deploy");const c=I.Mattermost.toLowerCase(),e=q({deploymentName:l.value,projectName:c,twinId:_.profile.twinId}),M=e+"."+r.value.domain;let u,y;try{u=await z(_.profile,c),await t.value.validateBalance(u),y=await W(u,{name:l.value,machines:[{name:l.value,cpu:a.value.cpu,memory:a.value.memory,disks:[{size:a.value.disk,mountPoint:"/var/lib/docker"}],flist:"https://hub.grid.tf/tf-official-apps/mattermost-latest.flist",entryPoint:"/sbin/zinit init",rootFilesystemSize:Y(a.value.cpu,a.value.memory),farmId:s.value.farmID,farmName:s.value.name,country:s.value.country,planetary:!0,envs:[{key:"SSH_KEY",value:_.profile.ssh},{key:"DB_PASSWORD",value:w(12)},{key:"SITE_URL",value:"https://"+M},{key:"MATTERMOST_DOMAIN",value:M},...m.value.enabled?[{key:"SMTPUsername",value:m.value.username},{key:"SMTPPassword",value:m.value.password},{key:"SMTPServer",value:m.value.hostname},{key:"SMTPPort",value:m.value.port.toString()}]:[]]}]})}catch(S){return t.value.setStatus("failed",V(S,"Failed to deploy a mattermost instance."))}try{t.value.setStatus("deploy","Preparing to deploy gateway..."),await Q(u,{name:e,nodeId:r.value.id,backends:[`http://[${y[0].planetary}]:8000`]}),t.value.reloadDeploymentsList(),t.value.setStatus("success","Successfully deployed a mattermost instance."),t.value.openDialog(y,{DB_PASSWORD:"Database Password",SITE_URL:"Site URL",SMTPUsername:"SMTP Username",SMTPPassword:"SMTP Password",SMTPServer:"SMTP Server",SMTPPort:"SMTP Port",SSH_KEY:"Public SSH Key",MATTERMOST_DOMAIN:"Mattermost Domain"})}catch(S){t.value.setStatus("deploy","Rollbacking back due to fail to deploy gateway..."),await J(u,l.value),t.value.setStatus("failed",V(S,"Failed to deploy a mattermost instance."))}}return(c,e)=>{const M=p("v-text-field"),u=p("input-validator"),y=p("d-tabs"),S=p("v-btn"),E=p("weblet-layout");return D(),O(E,{ref_key:"layout",ref:t},{title:n(()=>[P("Deploy a Mattermost Instance ")]),subtitle:n(()=>[P(" Mattermost A single point of collaboration. Designed specifically for digital operations. "),ee]),"footer-actions":n(()=>{var i;return[o(S,{color:"primary",variant:"tonal",onClick:B,disabled:(i=b.value)==null?void 0:i.invalid},{default:n(()=>[P(" Deploy ")]),_:1},8,["disabled"])]}),default:n(()=>[o(y,{tabs:[{title:"Base",value:"base"},{title:"SMTP Server",value:"smtp"}],ref_key:"tabs",ref:b},{base:n(()=>{var i,g,k;return[o(u,{value:l.value,rules:[c.validators.required("Name is required."),c.validators.minLength("Name minLength is 2 chars.",2),c.validators.maxLength("Name maxLength is 15 chars.",15)]},{default:n(({props:d})=>[o(M,C({label:"Name",modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=F=>l.value=F)},d),null,16,["modelValue"])]),_:1},8,["value","rules"]),o(h,{modelValue:f(a),"onUpdate:modelValue":e[1]||(e[1]=d=>T(a)?a.value=d:null)},null,8,["modelValue"]),o(U,{modelValue:f(r),"onUpdate:modelValue":e[2]||(e[2]=d=>T(r)?r.value=d:null)},null,8,["modelValue"]),o(L,{filters:{cpu:(i=f(a))==null?void 0:i.cpu,memory:(g=f(a))==null?void 0:g.memory,ssd:(k=f(a))==null?void 0:k.disk,publicIp:!1},modelValue:f(s),"onUpdate:modelValue":e[3]||(e[3]=d=>T(s)?s.value=d:null)},null,8,["filters","modelValue"])]}),smtp:n(()=>[o($,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=i=>m.value=i)},null,8,["modelValue"])]),_:1},512)]),_:1},512)}}}),oe={name:"MattermostView",components:{TfMattermost:te,TfDeploymentList:X},setup(){return{name:I.Mattermost}}},le={class:"mt-4"};function se(R,t,b,_,l,a){const r=p("TfMattermost"),s=p("TfDeploymentList");return D(),H(K,null,[o(r),N("div",le,[o(s,{"project-name":_.name},null,8,["project-name"])])],64)}const de=G(oe,[["render",se]]);export{de as default};
