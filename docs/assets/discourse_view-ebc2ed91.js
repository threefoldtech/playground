import{g as L,h as j,i as z,r as q,_ as G}from"./tf_deployment_list.vue_vue_type_script_setup_true_lang-457f78f2.js";import{d as W,u as J,r as d,a as Q,b as p,o as h,c as X,w as l,g as V,e as T,f as t,h as w,m as Z,i as ee,j as O,H as ae,p as n,q as g,s as A,y as te,z as U,I as se,J as le,_ as oe,A as ne,F as re}from"./index-b070312d.js";import{_ as N,P as x,d as ue,r as C}from"./root_fs-ad9e737f.js";import{_ as K}from"./select_gateway_node.vue_vue_type_script_setup_true_lang-35400cc0.js";import{c as ie,_ as F}from"./smtp_server.vue_vue_type_script_setup_true_lang-0a7db58c.js";import"./list_table.vue_vue_type_script_setup_true_lang-7117335a.js";const me=A("a",{target:"_blank",href:"https://manual.grid.tf/weblets/weblets_discourse.html",class:"app-link"}," Quick start documentation ",-1),ce={name:"TfDiscourse",components:{SmtpServer:F,SelectSolutionFlavor:L,SelectGatewayNode:K,SelectFarm:N}},de=W({...ce,setup($){const s=J(),P=d(),S=Q(),r=d("DC"+V(9)),f=d(""),e=d(),i=d(),_=d(),m=d(ie());async function B(){s.value.setStatus("deploy");const v=x.Discourse.toLowerCase(),a=j({deploymentName:r.value,projectName:v,twinId:S.profile.twinId}),D=a+"."+i.value.domain;let u,y;try{u=await te(S.profile,v),await s.value.validateBalance(u),y=await ue(u,{name:r.value,machines:[{name:r.value,cpu:e.value.cpu,memory:e.value.memory,disks:[{size:e.value.disk,mountPoint:"/var/lib/docker"}],flist:"https://hub.grid.tf/tf-official-apps/forum-docker-v3.1.2.flist",entryPoint:"/sbin/zinit init",rootFilesystemSize:C(e.value.cpu,e.value.memory),farmId:_.value.farmID,farmName:_.value.name,country:_.value.country,planetary:!0,envs:[{key:"SSH_KEY",value:S.profile.ssh},{key:"DISCOURSE_HOSTNAME",value:D},{key:"DISCOURSE_DEVELOPER_EMAILS",value:f.value},{key:"DISCOURSE_SMTP_ADDRESS",value:m.value.hostname},{key:"DISCOURSE_SMTP_PORT",value:m.value.port.toString()},{key:"DISCOURSE_SMTP_ENABLE_START_TLS",value:m.value.tls?"true":"false"},{key:"DISCOURSE_SMTP_USER_NAME",value:m.value.username},{key:"DISCOURSE_SMTP_PASSWORD",value:m.value.password},{key:"THREEBOT_PRIVATE_KEY",value:H()},{key:"FLASK_SECRET_KEY",value:V(8)}]}]})}catch(E){return s.value.setStatus("failed",U(E,"Failed to deploy a discourse instance."))}try{s.value.setStatus("deploy","Preparing to deploy gateway..."),await z(u,{name:a,nodeId:i.value.id,backends:[`http://[${y[0].planetary}]:88`]}),s.value.reloadDeploymentsList(),s.value.setStatus("success","Successfully deployed a discourse instance."),s.value.openDialog(y,{SSH_KEY:"Public SSH Key",DISCOURSE_HOSTNAME:"Discourse Hostname",DISCOURSE_DEVELOPER_EMAILS:"Discourse Developer Emails",DISCOURSE_SMTP_ADDRESS:"Discourse SMTP Address",DISCOURSE_SMTP_PORT:"Discourse SMTP Port",DISCOURSE_SMTP_ENABLE_START_TLS:"Discourse SMTP Enable Start TLS",DISCOURSE_SMTP_USER_NAME:"Discourse SMTP Username",DISCOURSE_SMTP_PASSWORD:"Discourse SMTP Password",THREEBOT_PRIVATE_KEY:"Threebot Private Key",FLASK_SECRET_KEY:"Flask Secret Key"})}catch(E){s.value.setStatus("deploy","Rollbacking back due to fail to deploy gateway..."),await q(u,r.value),s.value.setStatus("failed",U(E,"Failed to deploy a discourse instance."))}}function H(){const v=se.box.keyPair();return le.Buffer.from(v.publicKey).toString("base64")}return(v,a)=>{const D=p("v-text-field"),u=p("input-validator"),y=p("d-tabs"),E=p("v-btn"),Y=p("weblet-layout");return h(),X(Y,{ref_key:"layout",ref:s},{title:l(()=>[T(" Deploy a Discourse Instance ")]),subtitle:l(()=>[T(" Discourse is the 100% open source discussion platform built for the next decade of the Internet. Use it as a mailing list, discussion forum, long-form chat room, and more! "),me]),"footer-actions":l(()=>{var c;return[t(E,{color:"primary",variant:"tonal",onClick:B,disabled:(c=P.value)==null?void 0:c.invalid},{default:l(()=>[T(" Deploy ")]),_:1},8,["disabled"])]}),default:l(()=>[t(y,{tabs:[{title:"Config",value:"config"},{title:"Mail Server",value:"mail"}],ref_key:"tabs",ref:P},{config:l(()=>{var c,R,k,I,M;return[t(u,{value:r.value,rules:[w("Name is required."),Z("Name minLength is 2 chars.",2),ee("Name maxLength is 15 chars.",15)]},{default:l(({props:o})=>[t(D,O({label:"Name",modelValue:r.value,"onUpdate:modelValue":a[0]||(a[0]=b=>r.value=b)},o),null,16,["modelValue"])]),_:1},8,["value","rules"]),t(u,{value:f.value,rules:[w("Email is required."),ae("Please provide a valid email address.")]},{default:l(({props:o})=>[t(D,O({label:"Email",placeholder:"This email will be used to login to your instance.",modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=b=>f.value=b)},o),null,16,["modelValue"])]),_:1},8,["value","rules"]),t(L,{modelValue:n(e),"onUpdate:modelValue":a[2]||(a[2]=o=>g(e)?e.value=o:null)},null,8,["modelValue"]),t(K,{modelValue:n(i),"onUpdate:modelValue":a[3]||(a[3]=o=>g(i)?i.value=o:null)},null,8,["modelValue"]),t(N,{filters:{cpu:(c=n(e))==null?void 0:c.cpu,memory:(R=n(e))==null?void 0:R.memory,ssd:(((k=n(e))==null?void 0:k.disk)??0)+n(C)(((I=n(e))==null?void 0:I.cpu)??0,((M=n(e))==null?void 0:M.memory)??0),publicIp:!1},modelValue:n(_),"onUpdate:modelValue":a[4]||(a[4]=o=>g(_)?_.value=o:null)},null,8,["filters","modelValue"])]}),mail:l(()=>[t(F,{modelValue:m.value,"onUpdate:modelValue":a[5]||(a[5]=c=>m.value=c),persistent:!0,tls:!0},{default:l(()=>[T(" Discourse needs SMTP service so please configure these settings properly. ")]),_:1},8,["modelValue"])]),_:1},512)]),_:1},512)}}}),pe={name:"DiscourseView",components:{TfDeploymentList:G,TfDiscourse:de},setup(){return{name:x.Discourse}}},_e={class:"mt-4"};function Se($,s,P,S,r,f){const e=p("TfDiscourse"),i=p("TfDeploymentList");return h(),ne(re,null,[t(e),A("div",_e,[t(i,{"project-name":S.name},null,8,["project-name"])])],64)}const Pe=oe(pe,[["render",Se]]);export{Pe as default};
