import{i as C,_ as L,P as h,j,d as Y,r as I,k as q,l as z,a as G}from"./tf_deployment_list.vue_vue_type_script_setup_true_lang-1803a4f6.js";import{d as W,u as Q,r as p,a as J,b as S,o as A,c as X,w as o,g as w,e as T,f as t,m as O,h as n,i as g,j as N,k as Z,n as U,x as ee,y as ae,_ as te,l as le,F as se}from"./index-df6f743d.js";import{_ as K}from"./select_gateway_node.vue_vue_type_script_setup_true_lang-ef88227d.js";import{c as oe,_ as F}from"./smtp_server.vue_vue_type_script_setup_true_lang-26828204.js";import"./list_table.vue_vue_type_script_setup_true_lang-046c7938.js";const re=N("a",{target:"_blank",href:"https://manual.grid.tf/weblets/weblets_discourse.html",class:"app-link"}," Quick start documentation ",-1),ne={name:"TfDiscourse",components:{SmtpServer:F,SelectSolutionFlavor:C,SelectGatewayNode:K,SelectFarm:L}},ue=W({...ne,setup($){const l=Q(),P=p(),v=J(),u=p("DC"+w(9)),f=p(""),e=p(),m=p(),_=p(),d=p(oe());async function B(){l.value.setStatus("deploy");const s=h.Discourse.toLowerCase(),a=j({deploymentName:u.value,projectName:s,twinId:v.profile.twinId}),D=a+"."+m.value.domain;let i,y;try{i=await Z(v.profile,s),await l.value.validateBalance(i),y=await Y(i,{name:u.value,machines:[{name:u.value,cpu:e.value.cpu,memory:e.value.memory,disks:[{size:e.value.disk,mountPoint:"/var/lib/docker"}],flist:"https://hub.grid.tf/tf-official-apps/forum-docker-v3.1.2.flist",entryPoint:"/sbin/zinit init",rootFilesystemSize:I(e.value.cpu,e.value.memory),farmId:_.value.farmID,farmName:_.value.name,country:_.value.country,planetary:!0,envs:[{key:"SSH_KEY",value:v.profile.ssh},{key:"DISCOURSE_HOSTNAME",value:D},{key:"DISCOURSE_DEVELOPER_EMAILS",value:f.value},{key:"DISCOURSE_SMTP_ADDRESS",value:d.value.hostname},{key:"DISCOURSE_SMTP_PORT",value:d.value.port.toString()},{key:"DISCOURSE_SMTP_ENABLE_START_TLS",value:d.value.tls?"true":"false"},{key:"DISCOURSE_SMTP_USER_NAME",value:d.value.username},{key:"DISCOURSE_SMTP_PASSWORD",value:d.value.password},{key:"THREEBOT_PRIVATE_KEY",value:x()},{key:"FLASK_SECRET_KEY",value:w(8)}]}]})}catch(E){return l.value.setStatus("failed",U(E,"Failed to deploy a discourse instance."))}try{l.value.setStatus("deploy","Preparing to deploy gateway..."),await q(i,{name:a,nodeId:m.value.id,backends:[`http://[${y[0].planetary}]:88`]}),l.value.reloadDeploymentsList(),l.value.setStatus("success","Successfully deployed a discourse instance."),l.value.openDialog(y,{SSH_KEY:"Public SSH Key",DISCOURSE_HOSTNAME:"Discourse Hostname",DISCOURSE_DEVELOPER_EMAILS:"Discourse Developer Emails",DISCOURSE_SMTP_ADDRESS:"Discourse SMTP Address",DISCOURSE_SMTP_PORT:"Discourse SMTP Port",DISCOURSE_SMTP_ENABLE_START_TLS:"Discourse SMTP Enable Start TLS",DISCOURSE_SMTP_USER_NAME:"Discourse SMTP Username",DISCOURSE_SMTP_PASSWORD:"Discourse SMTP Password",THREEBOT_PRIVATE_KEY:"Threebot Private Key",FLASK_SECRET_KEY:"Flask Secret Key"})}catch(E){l.value.setStatus("deploy","Rollbacking back due to fail to deploy gateway..."),await z(i,u.value),l.value.setStatus("failed",U(E,"Failed to deploy a discourse instance."))}}function x(){const s=ee.box.keyPair();return ae.Buffer.from(s.publicKey).toString("base64")}return(s,a)=>{const D=S("v-text-field"),i=S("input-validator"),y=S("d-tabs"),E=S("v-btn"),H=S("weblet-layout");return A(),X(H,{ref_key:"layout",ref:l},{title:o(()=>[T(" Deploy a Discourse Instance ")]),subtitle:o(()=>[T(" Discourse is the 100% open source discussion platform built for the next decade of the Internet. Use it as a mailing list, discussion forum, long-form chat room, and more! "),re]),"footer-actions":o(()=>{var c;return[t(E,{color:"primary",variant:"tonal",onClick:B,disabled:(c=P.value)==null?void 0:c.invalid},{default:o(()=>[T(" Deploy ")]),_:1},8,["disabled"])]}),default:o(()=>[t(y,{tabs:[{title:"Config",value:"config"},{title:"Mail Server",value:"mail"}],ref_key:"tabs",ref:P},{config:o(()=>{var c,R,k,M,V;return[t(i,{value:u.value,rules:[s.validators.required("Name is required."),s.validators.minLength("Name minLength is 2 chars.",2),s.validators.maxLength("Name maxLength is 15 chars.",15)]},{default:o(({props:r})=>[t(D,O({label:"Name",modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=b=>u.value=b)},r),null,16,["modelValue"])]),_:1},8,["value","rules"]),t(i,{value:f.value,rules:[s.validators.required("Email is required."),s.validators.isEmail("Please provide a valid email address.")]},{default:o(({props:r})=>[t(D,O({label:"Email",placeholder:"This email will be used to login to your instance.",modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=b=>f.value=b)},r),null,16,["modelValue"])]),_:1},8,["value","rules"]),t(C,{modelValue:n(e),"onUpdate:modelValue":a[2]||(a[2]=r=>g(e)?e.value=r:null)},null,8,["modelValue"]),t(K,{modelValue:n(m),"onUpdate:modelValue":a[3]||(a[3]=r=>g(m)?m.value=r:null)},null,8,["modelValue"]),t(L,{filters:{cpu:(c=n(e))==null?void 0:c.cpu,memory:(R=n(e))==null?void 0:R.memory,ssd:(((k=n(e))==null?void 0:k.disk)??0)+n(I)(((M=n(e))==null?void 0:M.cpu)??0,((V=n(e))==null?void 0:V.memory)??0),publicIp:!1},modelValue:n(_),"onUpdate:modelValue":a[4]||(a[4]=r=>g(_)?_.value=r:null)},null,8,["filters","modelValue"])]}),mail:o(()=>[t(F,{modelValue:d.value,"onUpdate:modelValue":a[5]||(a[5]=c=>d.value=c),persistent:!0,tls:!0},{default:o(()=>[T(" Discourse needs SMTP service so please configure these settings properly. ")]),_:1},8,["modelValue"])]),_:1},512)]),_:1},512)}}}),ie={name:"DiscourseView",components:{TfDeploymentList:G,TfDiscourse:ue},setup(){return{name:h.Discourse}}},me={class:"mt-4"};function de($,l,P,v,u,f){const e=S("TfDiscourse"),m=S("TfDeploymentList");return A(),le(se,null,[t(e),N("div",me,[t(m,{"project-name":v.name},null,8,["project-name"])])],64)}const fe=te(ie,[["render",de]]);export{fe as default};
