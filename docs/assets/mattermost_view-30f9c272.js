import{d as E,u as F,r as c,a as O,b as p,o as D,c as j,w as n,g as w,e as P,f as o,h as z,m as C,i as q,j as G,p as v,q as T,s as h,y as H,z as V,_ as K,A as W,F as Y}from"./index-db529f9f.js";import{_ as N,P as L,d as Q,r as J}from"./root_fs-a2832d70.js";import{g as I,h as X,i as Z,r as ee,_ as ae}from"./tf_deployment_list.vue_vue_type_script_setup_true_lang-584738f9.js";import{_ as U}from"./select_gateway_node.vue_vue_type_script_setup_true_lang-a273278c.js";import{c as te,_ as $}from"./smtp_server.vue_vue_type_script_setup_true_lang-f2d96074.js";import"./list_table.vue_vue_type_script_setup_true_lang-4e0f8b23.js";const oe=h("a",{target:"_blank",href:"https://library.threefold.me/info/manual/#/manual__weblets_mattermost",class:"app-link"}," Quick start documentation ",-1),le={name:"TfMattermost",components:{SmtpServer:$,SelectSolutionFlavor:I,SelectGatewayNode:U,SelectFarm:N}},se=E({...le,setup(x){const t=F(),M=c(),f=O(),l=c("MM"+w(9)),a=c(),r=c(),s=c(),m=c(te());async function R(){t.value.setStatus("deploy");const b=L.Mattermost.toLowerCase(),e=X({deploymentName:l.value,projectName:b,twinId:f.profile.twinId}),S=e+"."+r.value.domain;let u,_;try{u=await H(f.profile,b),await t.value.validateBalance(u),_=await Q(u,{name:l.value,machines:[{name:l.value,cpu:a.value.cpu,memory:a.value.memory,disks:[{size:a.value.disk,mountPoint:"/var/lib/docker"}],flist:"https://hub.grid.tf/tf-official-apps/mattermost-latest.flist",entryPoint:"/sbin/zinit init",rootFilesystemSize:J(a.value.cpu,a.value.memory),farmId:s.value.farmID,farmName:s.value.name,country:s.value.country,planetary:!0,envs:[{key:"SSH_KEY",value:f.profile.ssh},{key:"DB_PASSWORD",value:w(12)},{key:"SITE_URL",value:"https://"+S},{key:"MATTERMOST_DOMAIN",value:S},...m.value.enabled?[{key:"SMTPUsername",value:m.value.username},{key:"SMTPPassword",value:m.value.password},{key:"SMTPServer",value:m.value.hostname},{key:"SMTPPort",value:m.value.port.toString()}]:[]]}]})}catch(y){return t.value.setStatus("failed",V(y,"Failed to deploy a mattermost instance."))}try{t.value.setStatus("deploy","Preparing to deploy gateway..."),await Z(u,{name:e,nodeId:r.value.id,backends:[`http://[${_[0].planetary}]:8000`]}),t.value.reloadDeploymentsList(),t.value.setStatus("success","Successfully deployed a mattermost instance."),t.value.openDialog(_,{DB_PASSWORD:"Database Password",SITE_URL:"Site URL",SMTPUsername:"SMTP Username",SMTPPassword:"SMTP Password",SMTPServer:"SMTP Server",SMTPPort:"SMTP Port",SSH_KEY:"Public SSH Key",MATTERMOST_DOMAIN:"Mattermost Domain"})}catch(y){t.value.setStatus("deploy","Rollbacking back due to fail to deploy gateway..."),await ee(u,l.value),t.value.setStatus("failed",V(y,"Failed to deploy a mattermost instance."))}}return(b,e)=>{const S=p("v-text-field"),u=p("input-validator"),_=p("d-tabs"),y=p("v-btn"),A=p("weblet-layout");return D(),j(A,{ref_key:"layout",ref:t},{title:n(()=>[P("Deploy a Mattermost Instance ")]),subtitle:n(()=>[P(" Mattermost A single point of collaboration. Designed specifically for digital operations. "),oe]),"footer-actions":n(()=>{var i;return[o(y,{color:"primary",variant:"tonal",onClick:R,disabled:(i=M.value)==null?void 0:i.invalid},{default:n(()=>[P(" Deploy ")]),_:1},8,["disabled"])]}),default:n(()=>[o(_,{tabs:[{title:"Base",value:"base"},{title:"SMTP Server",value:"smtp"}],ref_key:"tabs",ref:M},{base:n(()=>{var i,g,k;return[o(u,{value:l.value,rules:[z("Name is required."),C("Name minLength is 2 chars.",2),q("Name maxLength is 15 chars.",15)]},{default:n(({props:d})=>[o(S,G({label:"Name",modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=B=>l.value=B)},d),null,16,["modelValue"])]),_:1},8,["value","rules"]),o(I,{modelValue:v(a),"onUpdate:modelValue":e[1]||(e[1]=d=>T(a)?a.value=d:null)},null,8,["modelValue"]),o(U,{modelValue:v(r),"onUpdate:modelValue":e[2]||(e[2]=d=>T(r)?r.value=d:null)},null,8,["modelValue"]),o(N,{filters:{cpu:(i=v(a))==null?void 0:i.cpu,memory:(g=v(a))==null?void 0:g.memory,ssd:(k=v(a))==null?void 0:k.disk,publicIp:!1},modelValue:v(s),"onUpdate:modelValue":e[3]||(e[3]=d=>T(s)?s.value=d:null)},null,8,["filters","modelValue"])]}),smtp:n(()=>[o($,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=i=>m.value=i)},null,8,["modelValue"])]),_:1},512)]),_:1},512)}}}),ne={name:"MattermostView",components:{TfMattermost:se,TfDeploymentList:ae},setup(){return{name:L.Mattermost}}},re={class:"mt-4"};function me(x,t,M,f,l,a){const r=p("TfMattermost"),s=p("TfDeploymentList");return D(),W(Y,null,[o(r),h("div",re,[o(s,{"project-name":f.name},null,8,["project-name"])])],64)}const fe=K(ne,[["render",me]]);export{fe as default};
